// Test script for dynamic category/subcategory creation
// Run this in MongoDB Compass shell to test the system

// Test 1: Add a recipe with a completely new category and subcategory
db.recipes.insertOne({
  slug: "lietuviska-barsciu-sriuba",
  title: {
    lt: "LietuviÅ¡ka barÅ¡ÄiÅ³ sriuba",
    en: "Lithuanian Beet Soup"
  },
  description: {
    lt: "TradicinÄ— lietuviÅ¡ka barÅ¡ÄiÅ³ sriuba su bulvÄ—mis ir deÅ¡ra.",
    en: "Traditional Lithuanian beet soup with potatoes and sausage."
  },
  
  // NEW CATEGORY PATH - this will auto-create category and subcategory
  categoryPath: "sriubos/karsti-barsÄiai",
  
  // SEO will be auto-generated by the upload API
  seo: {
    metaTitle: "LietuviÅ¡ka barÅ¡ÄiÅ³ sriuba - Receptas | Paragaujam.lt",
    metaDescription: "TradicinÄ— lietuviÅ¡ka barÅ¡ÄiÅ³ sriuba su bulvÄ—mis ir deÅ¡ra. Gaminimo laikas: 45 min. PorcijÅ³: 6.",
    keywords: ["barÅ¡Äiai", "lietuviÅ¡ka sriuba", "tradicinis receptas", "raudonieji barÅ¡Äiai"],
    canonicalUrl: "/receptai/sriubos/karsti-barsÄiai/lietuviska-barsciu-sriuba",
    lastModified: new Date()
  },
  
  schemaOrg: {
    "@context": "https://schema.org",
    "@type": "Recipe",
    name: "LietuviÅ¡ka barÅ¡ÄiÅ³ sriuba",
    description: "TradicinÄ— lietuviÅ¡ka barÅ¡ÄiÅ³ sriuba su bulvÄ—mis ir deÅ¡ra",
    totalTime: "PT45M",
    recipeCategory: "Sriuba",
    recipeCuisine: "LietuviÅ¡ka",
    recipeYield: "6 porcijos"
  },
  
  // Auto-generated breadcrumb
  breadcrumb: {
    main: { slug: "sriubos", label: "Sriubos" },
    sub: { slug: "karsti-barsÄiai", label: "KarÅ¡ti barÅ¡Äiai" }
  },
  
  servings: 6,
  totalTimeMinutes: 45,
  
  ingredients: [
    { name: { lt: "Raudonieji barÅ¡Äiai", en: "Red beet soup base" }, quantity: "500ml", vital: true },
    { name: { lt: "BulvÄ—s", en: "Potatoes" }, quantity: "3 vnt", vital: true },
    { name: { lt: "DeÅ¡ra", en: "Sausage" }, quantity: "200g", vital: true },
    { name: { lt: "SvogÅ«nas", en: "Onion" }, quantity: "1 vnt", vital: false }
  ],
  
  instructions: [
    { step: 1, description: { lt: "Nulupkite ir supjaustykite bulves.", en: "Peel and chop potatoes." } },
    { step: 2, description: { lt: "Supjaustykite deÅ¡rÄ… ir svogÅ«nÄ….", en: "Chop sausage and onion." } },
    { step: 3, description: { lt: "Virkite bulves 15 minuÄiÅ³.", en: "Boil potatoes for 15 minutes." } },
    { step: 4, description: { lt: "PridÄ—kite barÅ¡Äius ir deÅ¡rÄ…, virkite dar 10 min.", en: "Add beet soup and sausage, cook 10 more minutes." } }
  ],
  
  categories: {
    cuisine: "LietuviÅ¡ka",
    dietary: [],
    timeRequired: "iki 1val"
  },
  
  image: "/images/barsciu-sriuba.jpg",
  rating: { average: 4.7, count: 32 },
  
  performance: { views: 890, shares: 23, saves: 67 },
  
  status: "published",
  featured: false,
  trending: false,
  
  author: { name: "Paragaujam.lt", profileUrl: "/user/system" },
  
  createdAt: new Date(),
  updatedAt: new Date(),
  publishedAt: new Date()
});

// Test 2: Add another recipe to the same new subcategory
db.recipes.insertOne({
  slug: "salti-barsÄiai-su-kefyru",
  title: {
    lt: "Å alti barÅ¡Äiai su kefyru",
    en: "Cold Beet Soup with Kefir"
  },
  description: {
    lt: "GaivÅ«s Å¡alti barÅ¡Äiai su kefyru ir kiauÅ¡iniais - vasaros skonis.",
    en: "Refreshing cold beet soup with kefir and eggs - taste of summer."
  },
  
  // SAME NEW CATEGORY PATH - will add to existing subcategory
  categoryPath: "sriubos/karsti-barsÄiai",
  
  seo: {
    metaTitle: "Å alti barÅ¡Äiai su kefyru - Receptas | Paragaujam.lt",
    metaDescription: "GaivÅ«s Å¡alti barÅ¡Äiai su kefyru ir kiauÅ¡iniais. Gaminimo laikas: 20 min. PorcijÅ³: 4.",
    keywords: ["Å¡alti barÅ¡Äiai", "kefyras", "vasaros sriuba", "gaivÅ«s barÅ¡Äiai"],
    canonicalUrl: "/receptai/sriubos/karsti-barsÄiai/salti-barsÄiai-su-kefyru",
    lastModified: new Date()
  },
  
  schemaOrg: {
    "@context": "https://schema.org",
    "@type": "Recipe",
    name: "Å alti barÅ¡Äiai su kefyru",
    description: "GaivÅ«s Å¡alti barÅ¡Äiai su kefyru ir kiauÅ¡iniais",
    totalTime: "PT20M",
    recipeCategory: "Sriuba",
    recipeCuisine: "LietuviÅ¡ka",
    recipeYield: "4 porcijos"
  },
  
  breadcrumb: {
    main: { slug: "sriubos", label: "Sriubos" },
    sub: { slug: "karsti-barsÄiai", label: "KarÅ¡ti barÅ¡Äiai" }
  },
  
  servings: 4,
  totalTimeMinutes: 20,
  
  ingredients: [
    { name: { lt: "Å alti barÅ¡Äiai", en: "Cold beet soup" }, quantity: "1L", vital: true },
    { name: { lt: "Kefyras", en: "Kefir" }, quantity: "200ml", vital: true },
    { name: { lt: "KiauÅ¡iniai", en: "Eggs" }, quantity: "2 vnt", vital: true },
    { name: { lt: "AgurkÄ—liai", en: "Small cucumbers" }, quantity: "2 vnt", vital: false }
  ],
  
  instructions: [
    { step: 1, description: { lt: "IÅ¡virkite kiauÅ¡inius ir atvÄ—sinkite.", en: "Boil eggs and cool down." } },
    { step: 2, description: { lt: "SumaiÅ¡ykite barÅ¡Äius su kefyru.", en: "Mix beet soup with kefir." } },
    { step: 3, description: { lt: "Supjaustykite kiauÅ¡inius ir agurkÄ—lius.", en: "Chop eggs and cucumbers." } },
    { step: 4, description: { lt: "Patiekite su kiauÅ¡iniais ir agurkÄ—liais.", en: "Serve with eggs and cucumbers." } }
  ],
  
  categories: {
    cuisine: "LietuviÅ¡ka",
    dietary: [],
    timeRequired: "iki 30min"
  },
  
  image: "/images/salti-barsÄiai.jpg",
  rating: { average: 4.9, count: 78 },
  
  performance: { views: 1450, shares: 56, saves: 123 },
  
  status: "published",
  featured: true,
  trending: true,
  
  author: { name: "Paragaujam.lt", profileUrl: "/user/system" },
  
  createdAt: new Date(),
  updatedAt: new Date(),
  publishedAt: new Date()
});

// Test 3: Create the category structure automatically
// This simulates what the upload API would do
var existingCategory = db.categories.findOne({ slug: "sriubos" });

if (!existingCategory) {
  // Create new "sriubos" category
  db.categories.insertOne({
    slug: "sriubos",
    title: "Sriubos",
    description: "Å iltos ir maistingos sriubos kiekvienai dienai",
    image: "/images/categories/sriubos.jpg",
    icon: "ğŸ²",
    order: 3,
    status: "active",
    subcategories: [
      {
        slug: "karsti-barsÄiai",
        title: "KarÅ¡ti barÅ¡Äiai",
        description: "Tradiciniai lietuviÅ¡ki barÅ¡Äiai",
        image: "/images/subcategories/karsti-barsÄiai.jpg",
        recipeCount: 2,
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ],
    createdAt: new Date(),
    updatedAt: new Date()
  });
} else {
  // Add subcategory to existing category
  var subcategoryExists = existingCategory.subcategories?.some(sub => sub.slug === "karsti-barsÄiai");
  
  if (!subcategoryExists) {
    db.categories.updateOne(
      { slug: "sriubos" },
      {
        $push: {
          subcategories: {
            slug: "karsti-barsÄiai",
            title: "KarÅ¡ti barÅ¡Äiai",
            description: "Tradiciniai lietuviÅ¡ki barÅ¡Äiai",
            image: "/images/subcategories/karsti-barsÄiai.jpg",
            recipeCount: 2,
            createdAt: new Date(),
            updatedAt: new Date()
          }
        },
        $set: { updatedAt: new Date() }
      }
    );
  }
}

// Show results
print("âœ… Dynamic category test completed!");
print("ğŸ“Š Total recipes:", db.recipes.countDocuments());
print("ğŸ“‚ Total categories:", db.categories.countDocuments());

// Show the new category structure
var sriubosCategory = db.categories.findOne({ slug: "sriubos" });
if (sriubosCategory) {
  print("ğŸ² Sriubos category created:");
  print("   Title:", sriubosCategory.title);
  print("   Subcategories:", sriubosCategory.subcategories.length);
  sriubosCategory.subcategories.forEach(function(sub) {
    print("   - " + sub.title + " (" + sub.recipeCount + " recipes)");
  });
}

// Show recipes in the new category
var newRecipes = db.recipes.find({ categoryPath: "sriubos/karsti-barsÄiai" }).toArray();
print("ğŸ“ Recipes in sriubos/karsti-barsÄiai:", newRecipes.length);
newRecipes.forEach(function(recipe) {
  print("   - " + recipe.title.lt);
});

print("\nğŸ¯ Test URLs that should now work:");
print("   Category: http://localhost:3002/receptai/sriubos");
print("   Subcategory: http://localhost:3002/receptai/sriubos/karsti-barsÄiai");
print("   Recipe 1: http://localhost:3002/receptai/sriubos/karsti-barsÄiai/lietuviska-barsciu-sriuba");
print("   Recipe 2: http://localhost:3002/receptai/sriubos/karsti-barsÄiai/salti-barsÄiai-su-kefyru");
