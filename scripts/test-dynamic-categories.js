// Test script for dynamic category/subcategory creation
// Run this in MongoDB Compass shell to test the system

// Test 1: Add a recipe with a completely new category and subcategory
db.recipes.insertOne({
  slug: "lietuviska-barsciu-sriuba",
  title: {
    lt: "Lietuviška barščių sriuba",
    en: "Lithuanian Beet Soup"
  },
  description: {
    lt: "Tradicinė lietuviška barščių sriuba su bulvėmis ir dešra.",
    en: "Traditional Lithuanian beet soup with potatoes and sausage."
  },
  
  // NEW CATEGORY PATH - this will auto-create category and subcategory
  categoryPath: "sriubos/karsti-barsčiai",
  
  // SEO will be auto-generated by the upload API
  seo: {
    metaTitle: "Lietuviška barščių sriuba - Receptas | Paragaujam.lt",
    metaDescription: "Tradicinė lietuviška barščių sriuba su bulvėmis ir dešra. Gaminimo laikas: 45 min. Porcijų: 6.",
    keywords: ["barščiai", "lietuviška sriuba", "tradicinis receptas", "raudonieji barščiai"],
    canonicalUrl: "/receptai/sriubos/karsti-barsčiai/lietuviska-barsciu-sriuba",
    lastModified: new Date()
  },
  
  schemaOrg: {
    "@context": "https://schema.org",
    "@type": "Recipe",
    name: "Lietuviška barščių sriuba",
    description: "Tradicinė lietuviška barščių sriuba su bulvėmis ir dešra",
    totalTime: "PT45M",
    recipeCategory: "Sriuba",
    recipeCuisine: "Lietuviška",
    recipeYield: "6 porcijos"
  },
  
  // Auto-generated breadcrumb
  breadcrumb: {
    main: { slug: "sriubos", label: "Sriubos" },
    sub: { slug: "karsti-barsčiai", label: "Karšti barščiai" }
  },
  
  servings: 6,
  totalTimeMinutes: 45,
  
  ingredients: [
    { name: { lt: "Raudonieji barščiai", en: "Red beet soup base" }, quantity: "500ml", vital: true },
    { name: { lt: "Bulvės", en: "Potatoes" }, quantity: "3 vnt", vital: true },
    { name: { lt: "Dešra", en: "Sausage" }, quantity: "200g", vital: true },
    { name: { lt: "Svogūnas", en: "Onion" }, quantity: "1 vnt", vital: false }
  ],
  
  instructions: [
    { step: 1, description: { lt: "Nulupkite ir supjaustykite bulves.", en: "Peel and chop potatoes." } },
    { step: 2, description: { lt: "Supjaustykite dešrą ir svogūną.", en: "Chop sausage and onion." } },
    { step: 3, description: { lt: "Virkite bulves 15 minučių.", en: "Boil potatoes for 15 minutes." } },
    { step: 4, description: { lt: "Pridėkite barščius ir dešrą, virkite dar 10 min.", en: "Add beet soup and sausage, cook 10 more minutes." } }
  ],
  
  categories: {
    cuisine: "Lietuviška",
    dietary: [],
    timeRequired: "iki 1val"
  },
  
  image: "/images/barsciu-sriuba.jpg",
  rating: { average: 4.7, count: 32 },
  
  performance: { views: 890, shares: 23, saves: 67 },
  
  status: "published",
  featured: false,
  trending: false,
  
  author: { name: "Paragaujam.lt", profileUrl: "/user/system" },
  
  createdAt: new Date(),
  updatedAt: new Date(),
  publishedAt: new Date()
});

// Test 2: Add another recipe to the same new subcategory
db.recipes.insertOne({
  slug: "salti-barsčiai-su-kefyru",
  title: {
    lt: "Šalti barščiai su kefyru",
    en: "Cold Beet Soup with Kefir"
  },
  description: {
    lt: "Gaivūs šalti barščiai su kefyru ir kiaušiniais - vasaros skonis.",
    en: "Refreshing cold beet soup with kefir and eggs - taste of summer."
  },
  
  // SAME NEW CATEGORY PATH - will add to existing subcategory
  categoryPath: "sriubos/karsti-barsčiai",
  
  seo: {
    metaTitle: "Šalti barščiai su kefyru - Receptas | Paragaujam.lt",
    metaDescription: "Gaivūs šalti barščiai su kefyru ir kiaušiniais. Gaminimo laikas: 20 min. Porcijų: 4.",
    keywords: ["šalti barščiai", "kefyras", "vasaros sriuba", "gaivūs barščiai"],
    canonicalUrl: "/receptai/sriubos/karsti-barsčiai/salti-barsčiai-su-kefyru",
    lastModified: new Date()
  },
  
  schemaOrg: {
    "@context": "https://schema.org",
    "@type": "Recipe",
    name: "Šalti barščiai su kefyru",
    description: "Gaivūs šalti barščiai su kefyru ir kiaušiniais",
    totalTime: "PT20M",
    recipeCategory: "Sriuba",
    recipeCuisine: "Lietuviška",
    recipeYield: "4 porcijos"
  },
  
  breadcrumb: {
    main: { slug: "sriubos", label: "Sriubos" },
    sub: { slug: "karsti-barsčiai", label: "Karšti barščiai" }
  },
  
  servings: 4,
  totalTimeMinutes: 20,
  
  ingredients: [
    { name: { lt: "Šalti barščiai", en: "Cold beet soup" }, quantity: "1L", vital: true },
    { name: { lt: "Kefyras", en: "Kefir" }, quantity: "200ml", vital: true },
    { name: { lt: "Kiaušiniai", en: "Eggs" }, quantity: "2 vnt", vital: true },
    { name: { lt: "Agurkėliai", en: "Small cucumbers" }, quantity: "2 vnt", vital: false }
  ],
  
  instructions: [
    { step: 1, description: { lt: "Išvirkite kiaušinius ir atvėsinkite.", en: "Boil eggs and cool down." } },
    { step: 2, description: { lt: "Sumaišykite barščius su kefyru.", en: "Mix beet soup with kefir." } },
    { step: 3, description: { lt: "Supjaustykite kiaušinius ir agurkėlius.", en: "Chop eggs and cucumbers." } },
    { step: 4, description: { lt: "Patiekite su kiaušiniais ir agurkėliais.", en: "Serve with eggs and cucumbers." } }
  ],
  
  categories: {
    cuisine: "Lietuviška",
    dietary: [],
    timeRequired: "iki 30min"
  },
  
  image: "/images/salti-barsčiai.jpg",
  rating: { average: 4.9, count: 78 },
  
  performance: { views: 1450, shares: 56, saves: 123 },
  
  status: "published",
  featured: true,
  trending: true,
  
  author: { name: "Paragaujam.lt", profileUrl: "/user/system" },
  
  createdAt: new Date(),
  updatedAt: new Date(),
  publishedAt: new Date()
});

// Test 3: Create the category structure automatically
// This simulates what the upload API would do
var existingCategory = db.categories.findOne({ slug: "sriubos" });

if (!existingCategory) {
  // Create new "sriubos" category
  db.categories.insertOne({
    slug: "sriubos",
    title: "Sriubos",
    description: "Šiltos ir maistingos sriubos kiekvienai dienai",
    image: "/images/categories/sriubos.jpg",
    icon: "🍲",
    order: 3,
    status: "active",
    subcategories: [
      {
        slug: "karsti-barsčiai",
        title: "Karšti barščiai",
        description: "Tradiciniai lietuviški barščiai",
        image: "/images/subcategories/karsti-barsčiai.jpg",
        recipeCount: 2,
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ],
    createdAt: new Date(),
    updatedAt: new Date()
  });
} else {
  // Add subcategory to existing category
  var subcategoryExists = existingCategory.subcategories?.some(sub => sub.slug === "karsti-barsčiai");
  
  if (!subcategoryExists) {
    db.categories.updateOne(
      { slug: "sriubos" },
      {
        $push: {
          subcategories: {
            slug: "karsti-barsčiai",
            title: "Karšti barščiai",
            description: "Tradiciniai lietuviški barščiai",
            image: "/images/subcategories/karsti-barsčiai.jpg",
            recipeCount: 2,
            createdAt: new Date(),
            updatedAt: new Date()
          }
        },
        $set: { updatedAt: new Date() }
      }
    );
  }
}

// Show results
print("✅ Dynamic category test completed!");
print("📊 Total recipes:", db.recipes.countDocuments());
print("📂 Total categories:", db.categories.countDocuments());

// Show the new category structure
var sriubosCategory = db.categories.findOne({ slug: "sriubos" });
if (sriubosCategory) {
  print("🍲 Sriubos category created:");
  print("   Title:", sriubosCategory.title);
  print("   Subcategories:", sriubosCategory.subcategories.length);
  sriubosCategory.subcategories.forEach(function(sub) {
    print("   - " + sub.title + " (" + sub.recipeCount + " recipes)");
  });
}

// Show recipes in the new category
var newRecipes = db.recipes.find({ categoryPath: "sriubos/karsti-barsčiai" }).toArray();
print("📝 Recipes in sriubos/karsti-barsčiai:", newRecipes.length);
newRecipes.forEach(function(recipe) {
  print("   - " + recipe.title.lt);
});

print("\n🎯 Test URLs that should now work:");
print("   Category: http://localhost:3002/receptai/sriubos");
print("   Subcategory: http://localhost:3002/receptai/sriubos/karsti-barsčiai");
print("   Recipe 1: http://localhost:3002/receptai/sriubos/karsti-barsčiai/lietuviska-barsciu-sriuba");
print("   Recipe 2: http://localhost:3002/receptai/sriubos/karsti-barsčiai/salti-barsčiai-su-kefyru");
